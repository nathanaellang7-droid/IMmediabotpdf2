<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Bulk PDF Generator</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

<style>
body { font-family: Arial, sans-serif; background:#eef1ff; }
.container { max-width:1200px; margin:auto; padding:20px; }
table { width:100%; border-collapse:collapse; }
th,td { border:1px solid #ddd; padding:8px; }
input { width:100%; padding:6px; }
.preview img { width:70px; height:100px; object-fit:cover; }
button { padding:12px 20px; margin-top:15px; background:#667eea; color:#fff; border:none; cursor:pointer; }
</style>
</head>

<body>
<div class="container">
<h1>ðŸ“š Bulk PDF Generator</h1>

<table>
<thead>
<tr>
<th>OUTPUT FILE NAME</th>
<th>TITLE PDF</th>
<th>TITLE BOOK</th>
<th>AUTHOR</th>
<th>DOWNLOAD LINK</th>
<th>ASIN</th>
<th>Preview</th>
</tr>
</thead>
<tbody id="rows"></tbody>
</table>

<button onclick="addRow()">âž• Add Row</button>
<button onclick="generateZIP()">ðŸ“¦ Generate ZIP</button>
</div>

<script>
const rows = document.getElementById('rows');
addRow();

/* AUTO SLUG */
function slugify(text) {
  return text.toString().normalize('NFD')
    .replace(/[\u0300-\u036f]/g,'')
    .toLowerCase().trim()
    .replace(/[^a-z0-9]+/g,'-')
    .replace(/^-+|-+$/g,'');
}

function addRow() {
  const tr = document.createElement('tr');
  tr.innerHTML = `
    <td><input class="out"></td>
    <td><input class="pdf"></td>
    <td><input class="title"></td>
    <td><input class="author"></td>
    <td><input class="link"></td>
    <td><input class="asin" oninput="preview(this)"></td>
    <td class="preview"><img></td>
  `;
  rows.appendChild(tr);
}

function preview(el) {
  const row = el.closest('tr');
  row.querySelector('img').src =
    `https://images-na.ssl-images-amazon.com/images/P/${el.value}.01.LZZZZZZZ.jpg`;
}

async function buildPDF(data) {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({unit:'pt',format:'a4',compress:true});
  const W=595,H=842;

  /* PAGE 1 */
  const cover = new Image();
  cover.crossOrigin="anonymous";
  cover.src=`https://images-na.ssl-images-amazon.com/images/P/${data.asin}.01.LZZZZZZZ.jpg`;
  await new Promise(r=>cover.onload=r);

  doc.addImage(cover,'JPEG',(W-220)/2,40,220,330,undefined,'FAST');

  doc.setFont('times','bold');
  doc.setFontSize(18);
  doc.text(data.title_pdf,W/2,410,{align:'center'});

  doc.setFont('times','normal');
  doc.setFontSize(12);
  doc.text(
`Descarga o lee online el ebook gratuito ${data.title_book} (PDF ePub Mobi) -
${data.author}

Ebook PDF ${data.title_book} | DESCARGA ONLINE DE E-BOOKS
Si quieres descargar un ebook gratis, estÃ¡s en el lugar indicado.
Haz clic abajo para descargar el ebook ${data.title_book}.`,
W/2,450,{align:'center',maxWidth:420});

  doc.setFillColor(46,204,113);
  doc.roundedRect((W-260)/2,690,260,48,8,8,'F');
  doc.setTextColor(255);
  doc.text('DOWNLOAD',W/2,722,{align:'center'});
  doc.link((W-260)/2,690,260,48,{url:data.link});
  doc.setTextColor(0);

  /* FIXED TOTAL 5â€“6 PAGES */
  const previews=[
    'previews/p1.jpg','previews/p2.jpg','previews/p3.jpg',
    'previews/p4.jpg','previews/p5.jpg','previews/p6.jpg'
  ];
  const extraPages = Math.random()>0.5 ? 4 : 5; // + page 1
  const selected = previews.sort(()=>0.5-Math.random()).slice(0,extraPages);

  for(const src of selected){
    doc.addPage();
    const img=new Image();
    img.src=src;
    await new Promise(r=>img.onload=r);
    const ratio=Math.min(W/img.width,H/img.height);
    doc.addImage(
      img,'JPEG',
      (W-img.width*ratio)/2,
      (H-img.height*ratio)/2,
      img.width*ratio,
      img.height*ratio,
      undefined,'FAST'
    );
  }

  return doc.output('blob');
}

async function generateZIP() {
  const zip = new JSZip();
  const trs = rows.querySelectorAll('tr');

  for(const tr of trs) {
    const data = {
      output: tr.querySelector('.out').value,
      title_pdf: tr.querySelector('.pdf').value,
      title_book: tr.querySelector('.title').value,
      author: tr.querySelector('.author').value,
      link: tr.querySelector('.link').value,
      asin: tr.querySelector('.asin').value
    };
    if(!data.asin) continue;

    const blob = await buildPDF(data);
    const base = data.output || data.title_book;
    zip.file(`${slugify(base)}.pdf`, blob);
  }

  const content = await zip.generateAsync({type:'blob'});
  saveAs(content,'bulk-pdfs.zip');
}
</script>
</body>
</html>
